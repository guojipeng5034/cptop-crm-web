<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="keywords" content="CampusTop CRM" />
    <meta name="description" content="CampusTop CRM" />
    <title>%VITE_APP_TITLE%</title>
  </head>
  <body>
    <div id="app">
      <style>
        .app-loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          background: #f0f2f5;
          z-index: 9999;
          transition:
            opacity 0.6s ease-out,
            visibility 0.6s ease-out;
        }

        .app-loading.fade-out {
          opacity: 0;
          visibility: hidden;
        }

        .app-loading-wrap {
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          text-align: center;
        }

        /* 双圆环加载动画保持原有风格 */
        .app-loading-spinner {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 60px;
          margin-bottom: 30px;
          vertical-align: middle;
          border-radius: 50%;
        }

        .app-loading-outter {
          position: absolute;
          width: 100%;
          height: 100%;
          border: 4px solid #2d8cf0;
          border-bottom: 0;
          border-left-color: transparent;
          border-radius: 50%;
          animation: loader-outter 1s cubic-bezier(0.42, 0.61, 0.58, 0.41) infinite;
        }

        .app-loading-inner {
          position: absolute;
          top: calc(50% - 20px);
          left: calc(50% - 20px);
          width: 40px;
          height: 40px;
          border: 4px solid #87bdff;
          border-right: 0;
          border-top-color: transparent;
          border-radius: 50%;
          animation: loader-inner 1s cubic-bezier(0.42, 0.61, 0.58, 0.41) infinite;
        }

        @keyframes loader-outter {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        @keyframes loader-inner {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(-360deg);
          }
        }

        /* 进度条样式 */
        .progress-container {
          width: 300px;
          height: 8px;
          background: rgba(45, 140, 240, 0.1);
          border-radius: 4px;
          overflow: hidden;
          margin-bottom: 20px;
          box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #2d8cf0, #87bdff);
          border-radius: 4px;
          width: 0%;
          transition: width 0.3s ease-out;
          position: relative;
          overflow: hidden;
        }

        .progress-bar::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
          animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
          0% {
            transform: translateX(-100%);
          }
          100% {
            transform: translateX(100%);
          }
        }

        /* 进度信息 */
        .progress-info {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 300px;
          margin-bottom: 10px;
          font-size: 14px;
          color: #666;
        }

        .progress-percent {
          font-weight: bold;
          color: #2d8cf0;
        }

        .loading-status {
          font-size: 14px;
          color: #888;
          margin-top: 10px;
          min-height: 20px;
        }

        /* 响应式设计 */
        @media (max-width: 480px) {
          .progress-container,
          .progress-info {
            width: 80%;
            max-width: 280px;
          }

          .app-loading-logo {
            width: 80px;
          }

          .app-loading-title {
            font-size: 18px;
          }
        }

        /* 暗色主题支持 */
        @media (prefers-color-scheme: dark) {
          .app-loading {
            background: #1a1a1a;
          }

          .app-loading-title {
            color: #fff;
          }

          .progress-container {
            background: rgba(255, 255, 255, 0.1);
          }

          .loading-status {
            color: #ccc;
          }

          .progress-info {
            color: #ccc;
          }
        }
      </style>

      <div class="app-loading" id="app-loading">
        <div class="app-loading-wrap">
          <div class="app-loading-spinner">
            <div class="app-loading-outter"></div>
            <div class="app-loading-inner"></div>
          </div>

          <!-- 进度条区域 -->
          <div class="progress-info">
            <span class="loading-text">正在加载...</span>
            <span class="progress-percent" id="progress-percent">0%</span>
          </div>

          <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>

          <div class="loading-status" id="loading-status">初始化应用</div>
        </div>
      </div>
    </div>

    <script>
      class AdvancedProgressLoader {
        constructor() {
          this.progress = 0
          this.baseResources = 0
          this.dynamicResources = 0
          this.loadedResources = 0
          
          this.progressBar = document.getElementById('progress-bar')
          this.percentText = document.getElementById('progress-percent')
          this.statusText = document.getElementById('loading-status')
          this.loadingContainer = document.getElementById('app-loading')

          this.resourceTypes = new Set()
          this.loadedResourceTypes = new Set()
          this.startTime = Date.now()

          // 跟踪动态资源
          this.pendingScripts = new Set()
          this.loadedScripts = new Set()
          this.pendingStyles = new Set()
          this.loadedStyles = new Set()
          
          // 加载阶段
          this.loadingPhases = [
            { name: 'dom', weight: 10, completed: false },
            { name: 'static-resources', weight: 30, completed: false },
            { name: 'dynamic-resources', weight: 40, completed: false },
            { name: 'app-init', weight: 20, completed: false }
          ]
          
          this.isCompleting = false
          this.lastActivityTime = Date.now()

          this.init()
        }

        init() {
          // 计算基础资源
          this.calculateBaseResources()
          
          // 监听资源加载
          this.monitorResourceLoading()
          
          // 监听DOM操作来捕获动态资源
          this.monitorDynamicResources()

          // 监听DOM和应用状态
          this.monitorAppLoading()

          // 设置自动完成检测
          this.setupAutoCompletion()

          // 设置最大加载时间保护
          this.setMaxLoadingTime()
        }

        calculateBaseResources() {
          // 计算静态脚本数量
          const scripts = document.querySelectorAll('script[src]')
          scripts.forEach((script) => {
            this.baseResources++
            this.pendingScripts.add(script.src)
          })

          // 计算静态样式表数量
          const stylesheets = document.querySelectorAll('link[rel="stylesheet"]')
          stylesheets.forEach((link) => {
            this.baseResources++
            this.pendingStyles.add(link.href)
          })

          // 计算图片数量
          const images = document.querySelectorAll('img[src]')
          images.forEach(() => {
            this.baseResources++
          })

          this.updateStatus('正在计算资源...', 5)
        }

        monitorResourceLoading() {
          // 监听静态脚本加载
          this.monitorStaticScripts()

          // 监听静态样式加载
          this.monitorStaticStylesheets()

          // 监听图片加载
          this.monitorImages()

          // 监听字体加载
          this.monitorFonts()
        }

        monitorStaticScripts() {
          const scripts = document.querySelectorAll('script[src]')

          scripts.forEach((script) => {
            script.addEventListener('load', () => {
              this.onResourceLoaded('static-script', script.src)
              this.pendingScripts.delete(script.src)
              this.loadedScripts.add(script.src)
            })

            script.addEventListener('error', (e) => {
              console.warn('Script load error:', script.src)
              this.onResourceLoaded('static-script', script.src)
              this.pendingScripts.delete(script.src)
            })
          })
        }

        monitorStaticStylesheets() {
          const stylesheets = document.querySelectorAll('link[rel="stylesheet"]')

          stylesheets.forEach((link) => {
            // 检查是否已经加载
            if (link.sheet) {
              this.onResourceLoaded('static-style', link.href)
              this.pendingStyles.delete(link.href)
              this.loadedStyles.add(link.href)
              return
            }

            link.addEventListener('load', () => {
              this.onResourceLoaded('static-style', link.href)
              this.pendingStyles.delete(link.href)
              this.loadedStyles.add(link.href)
            })

            link.addEventListener('error', () => {
              console.warn('Stylesheet load error:', link.href)
              this.onResourceLoaded('static-style', link.href)
              this.pendingStyles.delete(link.href)
            })
          })
        }

        monitorImages() {
          const images = document.querySelectorAll('img[src]')

          images.forEach((img) => {
            if (img.complete) {
              this.onResourceLoaded('image', img.src)
              return
            }

            img.addEventListener('load', () => {
              this.onResourceLoaded('image', img.src)
            })

            img.addEventListener('error', () => {
              console.warn('Image load error:', img.src)
              this.onResourceLoaded('image', img.src)
            })
          })
        }

        monitorFonts() {
          if (document.fonts) {
            document.fonts.ready.then(() => {
              this.onResourceLoaded('fonts', 'system-fonts')
            })
          }
        }

        monitorDynamicResources() {
          // 重写 createElement 来监控动态创建的脚本和样式
          const originalCreateElement = document.createElement.bind(document)
          
          document.createElement = (tagName) => {
            const element = originalCreateElement(tagName)
            
            if (tagName.toLowerCase() === 'script') {
              this.setupDynamicScriptMonitoring(element)
            } else if (tagName.toLowerCase() === 'link') {
              this.setupDynamicLinkMonitoring(element)
            }
            
            return element
          }

          // 监听 DOM 变化来捕获动态添加的资源
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  if (node.tagName === 'SCRIPT' && node.src) {
                    this.handleDynamicScript(node)
                  } else if (node.tagName === 'LINK' && node.rel === 'stylesheet') {
                    this.handleDynamicLink(node)
                  }
                  
                  // 检查子节点
                  const scripts = node.querySelectorAll && node.querySelectorAll('script[src]')
                  const links = node.querySelectorAll && node.querySelectorAll('link[rel="stylesheet"]')
                  
                  if (scripts) {
                    scripts.forEach(script => this.handleDynamicScript(script))
                  }
                  if (links) {
                    links.forEach(link => this.handleDynamicLink(link))
                  }
                }
              })
            })
          })

          observer.observe(document.documentElement, {
            childList: true,
            subtree: true
          })
        }

        setupDynamicScriptMonitoring(script) {
          // 设置属性监听器
          const originalSetAttribute = script.setAttribute.bind(script)
          script.setAttribute = (name, value) => {
            originalSetAttribute(name, value)
            if (name === 'src' && value) {
              setTimeout(() => this.handleDynamicScript(script), 0)
            }
          }
        }

        setupDynamicLinkMonitoring(link) {
          const originalSetAttribute = link.setAttribute.bind(link)
          link.setAttribute = (name, value) => {
            originalSetAttribute(name, value)
            if ((name === 'href' || name === 'rel') && link.href && link.rel === 'stylesheet') {
              setTimeout(() => this.handleDynamicLink(link), 0)
            }
          }
        }

        handleDynamicScript(script) {
          if (!script.src || this.loadedScripts.has(script.src) || this.pendingScripts.has(script.src)) {
            return
          }

          this.dynamicResources++
          this.pendingScripts.add(script.src)
          this.lastActivityTime = Date.now()

          this.updateStatus('发现新脚本文件...', null)

          script.addEventListener('load', () => {
            this.onResourceLoaded('dynamic-script', script.src)
            this.pendingScripts.delete(script.src)
            this.loadedScripts.add(script.src)
          })

          script.addEventListener('error', (e) => {
            console.warn('Dynamic script load error:', script.src)
            this.onResourceLoaded('dynamic-script', script.src)
            this.pendingScripts.delete(script.src)
          })
        }

        handleDynamicLink(link) {
          if (!link.href || link.rel !== 'stylesheet' || this.loadedStyles.has(link.href) || this.pendingStyles.has(link.href)) {
            return
          }

          this.dynamicResources++
          this.pendingStyles.add(link.href)
          this.lastActivityTime = Date.now()

          this.updateStatus('发现新样式文件...', null)

          link.addEventListener('load', () => {
            this.onResourceLoaded('dynamic-style', link.href)
            this.pendingStyles.delete(link.href)
            this.loadedStyles.add(link.href)
          })

          link.addEventListener('error', () => {
            console.warn('Dynamic stylesheet load error:', link.href)
            this.onResourceLoaded('dynamic-style', link.href)
            this.pendingStyles.delete(link.href)
          })
        }

        monitorAppLoading() {
          // 监听 DOM 准备就绪
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              this.completePhase('dom')
            })
          } else {
            this.completePhase('dom')
          }

          // 监听所有资源加载完成
          if (document.readyState !== 'complete') {
            window.addEventListener('load', () => {
              this.checkStaticResourcesComplete()
            })
          } else {
            this.checkStaticResourcesComplete()
          }

          // 监听 Vue 应用挂载
          this.waitForVueApp()
        }

        checkStaticResourcesComplete() {
          if (this.pendingScripts.size === 0 && this.pendingStyles.size === 0) {
            this.completePhase('static-resources')
          }
        }

        waitForVueApp() {
          const checkVueApp = () => {
            const appElement = document.querySelector('#app')
            const hasVueInstance =
              window.Vue ||
              (appElement && appElement.__vue__) ||
              window.vueAppInstance ||
              (appElement && appElement._vnode) ||
              (appElement && appElement.children.length > 1)

            if (hasVueInstance) {
              setTimeout(() => {
                this.completePhase('app-init')
              }, 500)
              return
            }

            setTimeout(checkVueApp, 100)
          }

          setTimeout(checkVueApp, 300)
        }

        setupAutoCompletion() {
          // 检查是否应该自动完成加载
          const checkCompletion = () => {
            const now = Date.now()
            const timeSinceLastActivity = now - this.lastActivityTime
            
            // 如果3秒内没有新的资源活动，且基础资源已加载完成
            if (timeSinceLastActivity > 3000 && this.pendingScripts.size === 0 && this.pendingStyles.size === 0) {
              this.completePhase('dynamic-resources')
            }

            if (!this.isCompleting) {
              setTimeout(checkCompletion, 1000)
            }
          }

          setTimeout(checkCompletion, 5000)
        }

        onResourceLoaded(type, resource) {
          this.loadedResources++
          this.lastActivityTime = Date.now()

          // 根据资源类型更新状态文本
          const statusMap = {
            'static-script': '加载脚本文件',
            'dynamic-script': '加载动态脚本',
            'static-style': '加载样式文件',
            'dynamic-style': '加载动态样式',
            'image': '加载图片资源',
            'fonts': '加载字体文件'
          }

          const status = statusMap[type] || '加载资源'
          this.calculateAndUpdateProgress(status)

          // 检查阶段完成
          if (type.includes('script') || type.includes('style')) {
            this.checkStaticResourcesComplete()
            
            // 检查动态资源是否完成
            if (this.pendingScripts.size === 0 && this.pendingStyles.size === 0) {
              setTimeout(() => {
                if (this.pendingScripts.size === 0 && this.pendingStyles.size === 0) {
                  this.completePhase('dynamic-resources')
                }
              }, 1000)
            }
          }
        }

        completePhase(phaseName) {
          const phase = this.loadingPhases.find(p => p.name === phaseName)
          if (phase && !phase.completed) {
            phase.completed = true
            
            const phaseStatusMap = {
              'dom': 'DOM 准备就绪',
              'static-resources': '静态资源加载完成',
              'dynamic-resources': '动态资源加载完成',
              'app-init': '应用初始化完成'
            }
            
            this.calculateAndUpdateProgress(phaseStatusMap[phaseName])
            
            // 检查是否所有阶段都完成
            if (this.loadingPhases.every(p => p.completed)) {
              this.completeLoading()
            }
          }
        }

        calculateAndUpdateProgress(status) {
          // 基于阶段权重计算进度
          let totalProgress = 0
          
          this.loadingPhases.forEach(phase => {
            if (phase.completed) {
              totalProgress += phase.weight
            } else if (phase.name === 'static-resources' || phase.name === 'dynamic-resources') {
              // 为资源加载阶段计算部分进度
              const totalResources = this.baseResources + this.dynamicResources
              if (totalResources > 0) {
                const resourceProgress = (this.loadedResources / totalResources) * phase.weight
                totalProgress += Math.min(resourceProgress, phase.weight * 0.9) // 最多90%，留10%给完成标记
              }
            }
          })

          const progress = Math.min(95, totalProgress)
          this.updateStatus(status, progress)
        }

        updateStatus(text, progress) {
          if (progress !== null) {
            this.progress = progress
          }

          if (this.progressBar && progress !== null) {
            this.progressBar.style.width = `${progress}%`
          }

          if (this.percentText && progress !== null) {
            this.percentText.textContent = `${Math.round(progress)}%`
          }

          if (this.statusText && text) {
            this.statusText.textContent = text
          }
        }

        completeLoading() {
          if (this.isCompleting) return
          this.isCompleting = true

          // 确保进度达到100%
          this.updateStatus('加载完成', 100)

          setTimeout(() => {
            this.hideLoading()
          }, 800)
        }

        hideLoading() {
          if (this.loadingContainer) {
            this.loadingContainer.classList.add('fade-out')

            setTimeout(() => {
              this.loadingContainer.style.display = 'none'
            }, 600)
          }
        }

        setMaxLoadingTime() {
          // 设置最大加载时间为20秒
          setTimeout(() => {
            if (!this.isCompleting) {
              console.warn('Loading timeout, forcing completion')
              this.completeLoading()
            }
          }, 20000)
        }

        // 提供手动完成接口
        forceComplete() {
          this.loadingPhases.forEach(phase => {
            phase.completed = true
          })
          this.completeLoading()
        }

        // 提供手动添加资源接口
        addResource(type = 'script') {
          if (type === 'script') {
            this.dynamicResources++
          }
          this.lastActivityTime = Date.now()
        }

        // 提供手动标记资源完成接口
        markResourceComplete(type = 'script') {
          this.onResourceLoaded('dynamic-' + type, 'manual-' + Date.now())
        }
      }

      // 启动高级进度加载器
      const advancedLoader = new AdvancedProgressLoader()

      // 暴露给外部使用
      window.advancedProgressLoader = advancedLoader

      // 监听自定义的应用就绪事件
      window.addEventListener('vue-app-mounted', () => {
        advancedLoader.completePhase('app-init')
      })

      // 提供给外部调用的API
      window.loadingAPI = {
        // 手动添加资源计数
        addResource: (type) => advancedLoader.addResource(type),
        // 手动标记资源完成
        completeResource: (type) => advancedLoader.markResourceComplete(type),
        // 强制完成加载
        forceComplete: () => advancedLoader.forceComplete(),
        // 更新状态文本
        updateStatus: (text) => advancedLoader.updateStatus(text, null)
      }
    </script>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>